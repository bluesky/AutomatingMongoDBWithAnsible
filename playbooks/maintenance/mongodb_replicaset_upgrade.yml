---
- hosts: all
  gather_facts: yes
  become: yes
  serial: 1
  vars_files:
    - ../vars/main.yml
    - ../replicaset/vault.yml
  vars:
    required_packages:
      - "yum-plugin-versionlock"
    current_mongodb_version: "4.2"
    target_mongodb_version: "4.4"

  # Process is based on the following offical documentation...
  # https://docs.mongodb.com/manual/release-notes/4.4-upgrade-replica-set/
  tasks:

    - name: Ensure required packages are installed
      yum:
        name: yum-plugin-versionlock

    - name: Remove the old mongodb repository
      file:
        path: "/etc/yum.repos.d/mongodb-{{ current_mongodb_version }}.repo"
        state: absent

    - name: Ensure the target mongodb repository exists
      copy:
        dest: "/etc/yum.repos.d/mongodb-{{ target_mongodb_version }}.repo"
        content: |
          [mongodb-{{ target_mongodb_version }}]
          baseurl = https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/{{ target_mongodb_version }}/x86_64/
          gpgcheck = 1
          gpgkey = https://www.mongodb.org/static/pgp/server-{{ target_mongodb_version }}.asc
          name = Official MongoDB {{ target_mongodb_version }} yum repo
        owner: root
        group: root
        mode: 0644
      register: new_mongo

    - name: yum-clean-metadata
      command: yum clean metadata
      args:
        warn: no
      when: new_mongo.changed

    - name: Ensure mongodb-org* packages are version unlocked
      shell: yum versionlock delete mongodb-org*

    - name: Remove version lock confirmation file
      file:
        path: /root/mongo_version_lock.success
        state: absent

    - name: Ensure that current replicaset state is good
      community.mongodb.mongodb_status:
        login_user: "{{ admin_user }}"
        login_password: "{{ admin_user_password }}"
        poll: 3
        interval: 10

    - name: Stepdown if primary
      community.mongodb.mongodb_stepdown:
        login_user: "{{ admin_user }}"
        login_password: "{{ admin_user_password }}"

    - name: Shutdown the mongod process cleanly
      community.mongodb.mongodb_shutdown:
        login_user: "{{ admin_user }}"
        login_password: "{{ admin_user_password }}"

    - name: Upgrade mongodb packages
      yum:
        name: mongodb*
        state: latest

    - name: Reboot the node
      reboot:
        reboot_timeout: 3600

    - name: Wait for mongodb to become active
      wait_for:
        port: "{{ mongod_port }}"
        delay: 10

    - name: Check the version of mongod
      shell: mongod --version | head -n 1
      register: mongod

    - name: Validate the running version of mongod
      assert:
        that: "'{{ target_mongodb_version }}' in mongod.stdout"

    - name: Validate the replicaset state again
      community.mongodb.mongodb_status:
        login_user: "{{ admin_user }}"
        login_password: "{{ admin_user_password }}"
        poll: 3
        interval: 10

    - name: Ensure mongodb-org* packages are version locked again
      shell: yum versionlock mongodb-org* && touch /root/mongo_version_lock.success
      args:
        creates: /root/mongo_version_lock.success
